#!/usr/bin/env bash
set -e

# Usa il nome del folder come IMAGE_NAME se non specificato
IMAGE_NAME="${IMAGE_NAME:-$(basename "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")}"
TAG="${TAG:-latest}"

# creo il folder localmente per essere eventualmente pronto alla dipendenza da locale del core e non far rompere poi il Containerfile
mkdir -p vendor

FORCE_REINSTALL_MCPCORE=""

# Se viene passato l'argomento "local-core", copia mcp-core nella cartella vendor/
if [[ "$1" == "local-core" ]]; then
    echo "=== Modalità sviluppo locale: includo mcp-core dal percorso ../mcp-core ==="
    rm -rf vendor/mcp-core
    cp -r ../mcp-core vendor/mcp-core
else
    echo "=== Modalità standard: userò mcp-core da repository remoto ==="
    if [[ "$2" == "force-reinstall-mcp-core" ]]; then
        FORCE_REINSTALL_MCPCORE="--build-arg FORCE_REINSTALL_MCPCORE=1"
    fi
    rm -rf vendor/mcp-core 2>/dev/null || true
fi

echo "=== Build container ${IMAGE_NAME}:${TAG} ==="
podman build -t "${IMAGE_NAME}:${TAG}" .

echo "=== Build completata con successo ==="
