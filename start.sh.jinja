#!/usr/bin/env bash
set -e

# --- Nome immagine: default = nome folder, lowercase, caratteri non validi sostituiti con '-' ---
RAW_IMAGE_NAME="$(basename "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")"
IMAGE_NAME="${IMAGE_NAME:-$(echo "$RAW_IMAGE_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')}"

TAG="${TAG:-latest}"
PORT="${PORT:-{{ port }}}"
DETACHED="${DETACHED:-false}"

# --- Costruzione comando podman ---
RUN_CMD="podman run --rm -p ${PORT}:${PORT} -v $(pwd)/tools:/app/tools"

if [ "$DETACHED" = "true" ]; then
    RUN_CMD="$RUN_CMD -d"
fi

# Passa eventuali argomenti aggiuntivi al container
RUN_CMD="$RUN_CMD $@ ${IMAGE_NAME}:${TAG}"

echo "=== Avvio container '${IMAGE_NAME}:${TAG}' sulla porta ${PORT} ==="
eval $RUN_CMD
